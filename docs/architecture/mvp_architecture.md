# MVPアーキテクチャ設計書

## 概要

altreのMVP（Minimum Viable Product）は、Rust + ratatuiを使用したTUIベースのEmacsライクテキストエディタです。本ドキュメントでは、実装の指針となるコアアーキテクチャを定義します。

## 設計原則

### 1. 簡潔性優先
MVPでは機能を最小限に絞り、高品質な実装を重視します。
- ギャップバッファによるシンプルなテキスト管理
- UTF-8とLFのみに限定した文字処理
- 明確なモジュール境界

### 2. 拡張性への配慮
将来のalisp統合とGUI展開を見据えた設計とします。
- モジュール間の疎結合
- 安定したインターフェース定義
- プラグイン機構への準備

### 3. パフォーマンス重視
レスポンシブな操作感を保証します。
- 効率的な描画更新
- 無駄なメモリアロケーションの回避
- 非同期処理の適切な活用

## システム全体構成

```
┌─────────────────────────────────────────────┐
│                 main.rs                     │
│            (アプリケーション起動)               │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│                 App                         │
│          (メインアプリケーション)              │
│  ┌─────────────┬──────────────┬─────────────┐ │
│  │   Buffer    │   UI Layer   │ Input/Event │ │
│  │   Manager   │   (ratatui)  │   Handler   │ │
│  └─────────────┴──────────────┴─────────────┘ │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│               Core Modules                  │
├─────────────────┬───────────────────────────┤
│ buffer/         │ テキストバッファ管理          │
├─────────────────┼───────────────────────────┤
│ input/          │ キーバインドと入力処理        │
├─────────────────┼───────────────────────────┤
│ ui/             │ TUI描画とレイアウト          │
├─────────────────┼───────────────────────────┤
│ file/           │ ファイルI/O操作             │
├─────────────────┼───────────────────────────┤
│ minibuffer/     │ ミニバッファシステム          │
├─────────────────┼───────────────────────────┤
│ error.rs        │ エラーハンドリング            │
└─────────────────┴───────────────────────────┘
```

## モジュール詳細設計

### 1. メインアプリケーション (`main.rs`, `app.rs`)

**責務**:
- アプリケーション初期化
- メインイベントループ
- 各モジュールの統合管理
- 適切な終了処理

**主要構造体**:
```rust
pub struct App {
    buffer_manager: BufferManager,
    ui_state: UiState,
    input_handler: InputHandler,
    minibuffer: MinibufferState,
    running: bool,
}
```

**主要機能**:
- `new()` - アプリケーション初期化
- `run()` - メインイベントループ実行
- `handle_event()` - イベント処理分散
- `render()` - UI描画制御
- `shutdown()` - 終了処理

### 2. バッファ管理 (`buffer/`)

**責務**:
- テキストデータの管理
- 編集操作の実行
- カーソル位置管理
- UTF-8文字操作の安全性保証

**主要ファイル**:
- `buffer/mod.rs` - モジュール公開インターフェース
- `buffer/gap_buffer.rs` - ギャップバッファ実装
- `buffer/cursor.rs` - カーソル位置管理
- `buffer/operations.rs` - 編集操作実装

**主要構造体**:
```rust
pub struct BufferManager {
    buffers: HashMap<BufferId, Buffer>,
    current_buffer: Option<BufferId>,
}

pub struct Buffer {
    content: GapBuffer,
    cursor: CursorPosition,
    file_path: Option<PathBuf>,
    modified: bool,
}
```

### 3. 入力処理 (`input/`)

**責務**:
- キーボード入力の受信
- キーバインドのマッピング
- コマンドディスパッチ
- Emacsスタイルキーシーケンス処理

**主要ファイル**:
- `input/mod.rs` - 入力処理公開インターフェース
- `input/keybinding.rs` - キーバインド定義と処理
- `input/commands.rs` - コマンド実装
- `input/event_handler.rs` - イベント処理ロジック

**主要構造体**:
```rust
pub struct InputHandler {
    keymap: KeyMap,
    key_sequence: Vec<KeyEvent>,
    command_processor: CommandProcessor,
}

pub struct KeyMap {
    global_bindings: HashMap<KeySequence, Command>,
}
```

### 4. UI層 (`ui/`)

**責務**:
- ratatuiによる画面描画
- レイアウト管理
- テキストレンダリング
- カーソル表示

**主要ファイル**:
- `ui/mod.rs` - UI機能公開インターフェース
- `ui/layout.rs` - 画面レイアウト管理
- `ui/text_area.rs` - テキストエリア描画
- `ui/minibuffer.rs` - ミニバッファ描画

**主要構造体**:
```rust
pub struct UiState {
    layout: LayoutManager,
    theme: Theme,
    terminal: Terminal<CrosstermBackend<Stdout>>,
}
```

### 5. ファイル操作 (`file/`)

**責務**:
- ファイル読み込み・保存
- パス処理と正規化
- エンコーディング処理
- エラーハンドリング

**主要ファイル**:
- `file/mod.rs` - ファイル操作公開インターフェース
- `file/io.rs` - ファイルI/O実装
- `file/path.rs` - パス処理ユーティリティ

### 6. ミニバッファ (`minibuffer/`)

**責務**:
- コマンド入力受付
- ファイルパス補完
- エラーメッセージ表示
- プロンプト管理

**主要ファイル**:
- `minibuffer/mod.rs` - ミニバッファ公開インターフェース
- `minibuffer/completion.rs` - 補完機能実装
- `minibuffer/prompt.rs` - プロンプト管理

### 7. エラーハンドリング (`error.rs`)

**責務**:
- 統一されたエラー型定義
- エラーメッセージの国際化
- ログ出力制御

## データフロー設計

### 1. ユーザー入力からレスポンスまでの処理フロー

```
ユーザー入力 (キーボード)
    ↓
crossterm::event::read()
    ↓
InputHandler::handle_key_event()
    ↓
KeyMap::lookup_command()
    ↓
Command::execute()
    ↓
BufferManager::apply_operation()
    ↓
UI::render()
    ↓
画面更新
```

### 2. ファイル操作フロー

```
C-x C-f (find-file)
    ↓
ミニバッファでパス入力
    ↓
TAB補完処理
    ↓
ファイル読み込み
    ↓
新しいBufferの作成
    ↓
UI更新
```

### 3. エラー処理フロー

```
エラー発生
    ↓
Result<T, AltreError>
    ↓
エラーログ記録
    ↓
ユーザー向けメッセージ生成
    ↓
ミニバッファに表示
```

## メモリ管理戦略

### 1. バッファ管理
- ギャップバッファによる効率的なテキスト編集
- 必要に応じたリアロケーション
- UTF-8文字境界の安全な処理

### 2. UI状態管理
- 描画状態のキャッシュ
- 差分更新による最適化
- メモリリークの防止

### 3. イベント処理
- イベントキューの適切なサイズ制限
- 長時間実行タスクの分割

## パフォーマンス要件

### 1. 応答性
- キー入力から画面更新まで: 16ms以内（60fps）
- ファイル読み込み: 100KB/秒以上
- メモリ使用量: ベースライン10MB以下

### 2. スケーラビリティ
- 10,000行までのファイルで快適な動作
- 1MB未満のファイルサイズでレスポンス保証

## セキュリティ考慮事項

### 1. ファイルアクセス
- パストラバーサル攻撃の防止
- 権限チェックの徹底
- シンボリックリンクの安全な処理

### 2. 入力検証
- UTF-8の厳密な検証
- 制御文字の適切な処理
- バッファオーバーフローの防止

## テスト戦略

### 1. 単体テスト
- 各モジュールの基本機能テスト
- エラーケースの網羅
- UTF-8エッジケースの確認

### 2. プロパティベーステスト
- ギャップバッファの不変条件確認
- UTF-8操作の安全性確認
- ファイルI/Oの整合性確認

### 3. 統合テスト
- 機能間の連携確認
- エンドツーエンドシナリオ
- パフォーマンス測定

## 実装優先順位

### Phase 1: コア基盤
1. エラーハンドリングシステム
2. ギャップバッファ実装
3. 基本的なアプリケーション構造

### Phase 2: 基本機能
1. テキスト編集操作
2. ファイルI/O
3. 基本UI描画

### Phase 3: 高度な機能
1. キーバインドシステム
2. ミニバッファ
3. 補完機能

### Phase 4: 統合・最適化
1. 全機能の統合
2. パフォーマンス最適化
3. テスト整備

## 将来拡張への配慮

### 1. alisp統合準備
- モジュール間のAPI安定化
- スクリプト可能なインターフェース設計
- セキュリティ境界の明確化

### 2. GUI移行準備
- UI層の抽象化
- 描画ロジックの分離
- イベント処理の一般化

### 3. 機能拡張準備
- プラグインシステムの基盤
- 設定管理の仕組み
- 外部ツール統合の準備

---

このアーキテクチャ設計により、alte MVPは高品質で拡張可能なテキストエディタとして実装されます。