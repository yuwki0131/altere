# Emacs検索・置換機能仕様分析

## タスク概要
Emacsの検索・置換機能を詳細に分析し、altreでの実装仕様を策定する。

## 目的
- Emacsの検索・置換機能の完全な理解と仕様化
- altreにおける実装要件の明確化
- キーバインドとユーザーインターフェースの設計

## Emacs検索機能の詳細分析

### 基本的な検索機能
1. **インクリメンタル検索（`C-s`）**
   - 前方検索（Forward Incremental Search）
   - リアルタイムでの検索マッチ表示
   - 検索語の逐次入力による絞り込み

2. **後方インクリメンタル検索（`C-r`）**
   - 後方向（Backward Incremental Search）
   - カーソル位置から前方への検索

3. **検索語の操作**
   - `C-s`/`C-r`：次/前の検索結果に移動
   - `Enter`：検索終了、現在位置に留まる
   - `C-g`：検索キャンセル、元の位置に戻る
   - `Backspace`：検索語の最後の文字を削除
   - `C-w`：カーソル位置の単語を検索語に追加
   - `C-y`：kill ringの内容を検索語に追加

### 高度な検索機能
1. **正規表現検索**
   - `C-M-s`：前方正規表現検索
   - `C-M-r`：後方正規表現検索

2. **非インクリメンタル検索**
   - `C-s RET`：前方検索（一度にクエリを入力）
   - `C-r RET`：後方検索（一度にクエリを入力）

3. **検索設定とオプション**
   - 大文字小文字の区別（case-sensitive/insensitive）
   - 単語境界での検索（word boundary）

## Emacs置換機能の詳細分析

### 基本的な置換機能
1. **クエリ置換（`M-%`）**
   - インタラクティブな置換（一つずつ確認）
   - 置換候補の表示とユーザー選択

2. **置換時のキー操作**
   - `y` or `SPC`：置換実行して次へ
   - `n` or `DEL`：置換せずに次へ
   - `!`：残り全て置換
   - `q` or `Enter`：置換終了
   - `^`：前の置換に戻る
   - `C-g`：置換キャンセル

3. **正規表現置換（`C-M-%`）**
   - 正規表現パターンでの置換
   - キャプチャグループ（`\1`、`\2`等）の利用

### 高度な置換機能
1. **矩形置換（Rectangle Replace）**
   - 矩形選択領域での置換

2. **条件付き置換**
   - Lisp式による条件判定

## 実装要件

### 必須機能（MVP）
1. **インクリメンタル検索**
   - `C-s`/`C-r`による前方・後方検索
   - リアルタイムハイライト
   - 基本的なキー操作（Enter、C-g、Backspace）

2. **基本置換**
   - `M-%`によるクエリ置換
   - 基本的な置換操作（y/n/q/!）

### 将来実装機能
1. **正規表現検索・置換**
2. **検索履歴管理**
3. **高度な置換オプション**

## 技術要件

### データ構造
1. **検索状態管理**
   ```rust
   struct SearchState {
       pattern: String,
       position: usize,
       direction: SearchDirection,
       is_active: bool,
       matches: Vec<Match>,
   }
   ```

2. **置換状態管理**
   ```rust
   struct ReplaceState {
       search_pattern: String,
       replacement: String,
       current_match: usize,
       matches: Vec<Match>,
   }
   ```

### UI/UX設計
1. **ミニバッファ統合**
   - 検索語入力用プロンプト
   - 置換確認用インターフェース

2. **視覚的フィードバック**
   - 検索結果のハイライト
   - 現在の検索位置表示
   - 置換候補の強調表示

### 性能要件
1. **インクリメンタル検索の応答性**
   - 100ms以内の検索結果更新
   - 大きなファイルでの効率的な検索

2. **メモリ効率性**
   - 検索結果のキャッシュ管理
   - 不要な検索状態の適切な解放

## 成果物
- 検索・置換機能の詳細仕様書
- 実装タスクの分解と優先順位付け
- インターフェース設計仕様

## 依存タスク
- ミニバッファシステムの充実
- キーバインドシステムの拡張
- テキスト選択・ハイライト機能

## 完了条件
- [ ] Emacsの検索・置換機能の完全な調査完了
- [ ] altreでの実装要件の明文化
- [ ] 技術仕様とアーキテクチャの設計完了
- [ ] 実装タスクの詳細分解完了

## 進捗記録
- 作成日：2025-01-28
- 状態：調査・分析フェーズ