# 検索・置換 UI/UX 設計

## 概要
本書は、altreの検索および置換機能に関するユーザーインターフェース設計を定義する。Emacsに近い操作感を保ちながら、ratatuiベースのTUIで視認性と操作性を両立させることが目的である。

## デザイン原則
1. **即時フィードバック**: 入力と同時に結果を表示し、状態変化を明確に伝える。
2. **コンテキスト維持**: 検索中も本文の読みやすさを損なわず、ハイライト範囲は最小限に留める。
3. **一貫性**: 既存のミニバッファUIやメッセージ表示と統一感のある見た目にする。
4. **エラーの可視化**: 失敗時は色やラベルで明示的に通知し、ユーザーが次に取るアクションを推測しやすくする。

## ミニバッファ表示仕様
```
┌───────────────────────────────────────┐
│ I-search: fo │ [2/5] │ wrapped │        │  🔍 │
└───────────────────────────────────────┘
```
- **プロンプト**: モードに応じて `I-search:` / `I-search backward:` / `Query replace:` を表示。
- **入力域**: 検索語／置換語を編集できる。日本語入力時も考慮し、IMEプレエディットを折返し表示。
- **メタ情報**: 現在マッチ番号、総マッチ数、折り返し、置換済み件数などをタグ形式で表示。
- **アイコン領域**: 状態アイコン（🔍検索中、⚠失敗、✔確定）を用意し、色覚多様性に配慮。

### 状態テーブル
| 状態 | ラベル | カラーリング | 動作 |
| --- | --- | --- | --- |
| 検索中 | `Searching` | 青文字+下線 | 入力を受け付け、結果を更新 |
| 成功 | `Match` | 緑背景 | 最新マッチを強調 |
| 失敗 | `Fail` | 赤背景+白文字 | カーソルは停止、次入力待ち |
| 折り返し | `Wrap` | 黄背景 | 初回のみ通知 |
| 置換確認 | `Replace?` | マゼンタ枠 | `y/n/!/q`入力待ち |

## 本文ハイライト
- `ui/highlight.rs` で `HighlightLayer::SearchCurrent` と `HighlightLayer::SearchOthers` を新設。
- **現在マッチ**: 背景色=シアン、前景色=黒、太字。
- **その他マッチ**: 背景色=ダークシアン、前景色=白。
- ハイライト範囲は表示中の行に限定し、スクロール時に再計算。
- 置換中は置換予定箇所をマゼンタ破線枠で表現し、確定後に通常表示へ戻す。

## 入力フロー
1. **検索開始 (`C-s`)**
   - ミニバッファ表示を検索モードへ切替。
   - ハイライトは初期状態で非表示。
2. **文字入力**
   - 文字追加→即座にマッチ探索。
   - ミニバッファ内のマッチカウンタを更新。
3. **マッチ移動 (`C-s`/`C-r`)**
   - 現在のハイライトを更新し、該当行を中央付近にスクロール。
4. **終了 (`Enter`) / キャンセル (`C-g`)**
   - ミニバッファを閉じ、ハイライト解除。キャンセル時はステータスメッセージで通知。
5. **置換 (`M-%`)**
   - ステップ1: 検索語入力。
   - ステップ2: 置換語入力。
   - ステップ3: マッチ箇所をミニバッファにプレビュー（`from -> to`）。
   - ステップ4: `y/n/!/q`入力で進行、カウンタを更新。

## メッセージデザイン
- 成功: `検索完了 (3件)`
- 折り返し: `検索が折り返しました`
- 失敗: `foo は見つかりません`
- 置換完了: `3件置換しました`
- キャンセル: `検索をキャンセルしました`

メッセージは `minibuffer::messages` に登録し、色/themeは `ui/theme` で定義する。

## アクセシビリティ
- 色のみで状態を伝えないよう、ラベルとアイコンを併用。
- 折り返し等の重要情報は1秒間強調表示後に通常色へ戻す。
- 文字入力中のビープ音は提供しない（TUIの制約を考慮）。

## テスト指針
- スナップショットテスト：ratatuiの描画結果からミニバッファ／ハイライトの組合せを検証。
- 入力シミュレーション：`app/tests/search_ui.rs`（新設予定）でキー操作を再現し、メッセージとハイライトの整合性を確認。
- 色テーマテスト：テーマ変更時も検索ハイライトの視認性を保てるか確認。

## 依存関係
- `docs/design/minibuffer.md`: プロンプト表示・メッセージAPI
- `docs/design/tui_layout.md`: レイアウトスロットの調整
- `docs/design/search_replace_spec.md`: 挙動仕様の整合性

## 将来拡張
- 正規表現検索時の構文ハイライト（メタ文字の表示）
- ハイライトテーマのカスタマイズ設定
- 異なるマッチ種別（正規表現グループ単位等）の色分け
- alispによる検索UI制御（ミニバッファのスクリプト化）

