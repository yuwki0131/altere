# モジュール依存関係図

## 概要

altreのMVPにおけるモジュール間の依存関係を定義します。依存関係は一方向を保ち、循環依存を避ける設計とします。

## 依存関係階層

### Level 1: 基盤層 (Foundation Layer)
基盤となるユーティリティとエラーハンドリング

```
error.rs (共通エラー型定義)
```

### Level 2: データ層 (Data Layer)
データ構造とコア機能

```
buffer/
├── gap_buffer.rs (ギャップバッファ実装)
├── cursor.rs (カーソル位置管理)
└── operations.rs (編集操作)

file/
├── io.rs (ファイルI/O)
└── path.rs (パス処理)
```

### Level 3: ロジック層 (Logic Layer)
ビジネスロジックとコマンド処理

```
input/
├── keybinding.rs (キーバインド)
├── commands.rs (コマンド実装)
└── event_handler.rs (イベント処理)

minibuffer/
├── completion.rs (補完機能)
└── prompt.rs (プロンプト管理)
```

### Level 4: 表示層 (Presentation Layer)
UI描画と表示制御

```
ui/
├── layout.rs (レイアウト管理)
├── text_area.rs (テキスト表示)
└── minibuffer.rs (ミニバッファ表示)
```

### Level 5: アプリケーション層 (Application Layer)
統合とメインループ

```
app.rs (アプリケーション状態管理)
main.rs (エントリーポイント)
```

## 詳細依存関係

### モジュール依存関係マトリックス

| モジュール | error | buffer | file | input | minibuffer | ui | app | main |
|-----------|-------|--------|------|-------|------------|----|----|------|
| error.rs  | -     | -      | -    | -     | -          | -  | -  | -    |
| buffer/   | ✓     | -      | -    | -     | -          | -  | -  | -    |
| file/     | ✓     | -      | -    | -     | -          | -  | -  | -    |
| input/    | ✓     | ✓      | ✓    | -     | -          | -  | -  | -    |
| minibuffer/| ✓    | -      | ✓    | -     | -          | -  | -  | -    |
| ui/       | ✓     | ✓      | -    | -     | ✓          | -  | -  | -    |
| app.rs    | ✓     | ✓      | ✓    | ✓     | ✓          | ✓  | -  | -    |
| main.rs   | ✓     | -      | -    | -     | -          | -  | ✓  | -    |

✓ = 依存関係あり, - = 依存関係なし

### 各モジュールの依存詳細

#### error.rs
- **依存するモジュール**: なし
- **役割**: 共通エラー型定義
- **公開する型**: `AltreError`, `Result<T>`

#### buffer/
- **依存するモジュール**: `error`
- **役割**: テキストデータ管理
- **公開する型**: `GapBuffer`, `CursorPosition`, `BufferManager`
- **主要API**:
  - `insert_char(pos, ch)` - 文字挿入
  - `delete_char(pos)` - 文字削除
  - `get_text()` - テキスト取得

#### file/
- **依存するモジュール**: `error`
- **役割**: ファイル操作
- **公開する型**: `FileOperations`
- **主要API**:
  - `read_file(path)` - ファイル読み込み
  - `write_file(path, content)` - ファイル書き込み
  - `expand_path(path)` - パス展開

#### input/
- **依存するモジュール**: `error`, `buffer`, `file`
- **役割**: 入力処理とコマンド実行
- **公開する型**: `InputHandler`, `KeyMap`, `Command`
- **主要API**:
  - `handle_key_event(event)` - キー入力処理
  - `execute_command(cmd)` - コマンド実行

#### minibuffer/
- **依存するモジュール**: `error`, `file`
- **役割**: ミニバッファ機能
- **公開する型**: `MinibufferState`, `CompletionEngine`
- **主要API**:
  - `prompt_user(message)` - ユーザープロンプト
  - `complete_path(partial)` - パス補完

#### ui/
- **依存するモジュール**: `error`, `buffer`, `minibuffer`
- **役割**: UI描画
- **公開する型**: `UiState`, `LayoutManager`
- **主要API**:
  - `render(terminal)` - 画面描画
  - `update_layout()` - レイアウト更新

#### app.rs
- **依存するモジュール**: すべて
- **役割**: アプリケーション統合
- **公開する型**: `App`
- **主要API**:
  - `new()` - アプリケーション初期化
  - `run()` - メインループ実行

#### main.rs
- **依存するモジュール**: `error`, `app`
- **役割**: エントリーポイント
- **主要機能**: アプリケーション起動と終了処理

## 依存関係のルール

### 1. 一方向依存
- 上位層は下位層に依存可能
- 下位層は上位層に依存禁止
- 同一層内での依存は最小限に

### 2. インターフェース安定性
- 公開APIの変更は慎重に
- 内部実装の変更は自由
- 破壊的変更は明確にバージョニング

### 3. テスト容易性
- 各モジュールは独立してテスト可能
- モックやスタブの利用を考慮
- 依存注入の仕組みを用意

## モジュール間通信パターン

### 1. 同期呼び出し
- 基本的な関数呼び出し
- エラーはResult型で伝播
- パフォーマンスクリティカルな部分

### 2. イベント駆動
- UIイベントの処理
- キーボード入力の伝達
- 状態変更の通知

### 3. 状態共有
- 読み取り専用の設定情報
- グローバルな状態（最小限）
- 適切な同期メカニズム

## モジュール分割の利点

### 1. 保守性
- 責務の明確な分離
- 変更影響範囲の限定
- コードの理解しやすさ

### 2. テスト性
- 単体テストの容易さ
- モック/スタブの利用
- テストの並列実行

### 3. 拡張性
- 新機能追加の容易さ
- 既存機能への影響最小化
- プラグイン機構への対応

## 将来の拡張考慮

### 1. alisp統合時
- `scripting/` モジュールの追加
- 各モジュールへのスクリプトAPI公開
- セキュリティ境界の設定

### 2. GUI対応時
- `ui/` モジュールの抽象化
- プラットフォーム固有実装の分離
- 共通描画インターフェースの定義

### 3. プラグインシステム
- 動的ロード機能の追加
- プラグインAPIの標準化
- サンドボックス機能の実装

---

この依存関係設計により、MVPの実装が整理され、将来の拡張が容易になります。